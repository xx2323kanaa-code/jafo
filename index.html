<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ankle Dorsi/Plantar Flexion Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TensorFlow + COCO -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body{
  margin:0;
  background:#fff;
  color:#000;
  font-family:system-ui, sans-serif;
}
#title{
  padding:6px;
  font-weight:bold;
}
#countNow{
  font-size:24px;
  padding:6px;
}
#video{
  width:100vw;
  height:60vh;        /* ‚òÖ Android ÂÆâÂÆö */
  object-fit:cover;
  background:#000;
}
#panel{
  position:fixed;
  bottom:0; left:0; right:0;
  background:#f0f0f0;
  border-top:1px solid #999;
}
button, select{
  margin:4px;
  padding:6px;
}
#hud{
  display:none;
  font-size:12px;
  max-height:160px;
  overflow:auto;
  white-space:pre;
  border-top:1px dashed #999;
  padding:4px;
}
</style>
</head>

<body>

<div id="title">Ankle Dorsi/Plantar Flexion Counter</div>
<div id="countNow">Now: 0</div>

<video id="video" autoplay muted playsinline></video>

<div id="panel">
  <button id="startBtn">üì∑ Start Camera</button>
  <select id="facing">
    <option value="user">Front</option>
    <option value="environment">Back</option>
  </select>
  <button id="hudBtn">HUD</button>
  <button id="csvBtn">CSV</button>
  <div id="hud"></div>
</div>

<script>
const video = document.getElementById("video");
const countNow = document.getElementById("countNow");
const hud = document.getElementById("hud");

let model = null;
let stream = null;
let running = false;

let lastFootY = null;
let lastEventTime = 0;
let lastSign = null;
let armed = false;

let sessionCount = 0;
let todayCount = 0;
let logs = [];

const MAX_LOGS = 200;

// ---- tuning (Ëß¶„Å£„Å¶OK) ----
const THRESH_ON  = 6;
const THRESH_OFF = 3;
const LOCK_MS    = 800;
const JUMP_CUT   = 120;

// ---- daily storage ----
const todayKey = new Date().toISOString().slice(0,10);
let history = JSON.parse(localStorage.getItem("ankleHistory") || "{}");
todayCount = history[todayKey] || 0;

// ---- camera ----
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: document.getElementById("facing").value }
  });
  video.srcObject = stream;

  // ‚òÖ ÂøÖ„Åö ready „ÇíÂæÖ„Å§
  await new Promise(r => video.onloadedmetadata = r);
  await video.play();
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

// ---- buttons ----
document.getElementById("startBtn").onclick = async () => {
  if(!running){
    if(!model) model = await cocoSsd.load();
    await startCamera();

    running = true;
    sessionCount = 0;
    countNow.textContent = "Now: 0";
    detectLoop();

    document.getElementById("startBtn").textContent = "‚èπ Stop";
  }else{
    running = false;
    stopCamera();

    todayCount += sessionCount;
    history[todayKey] = todayCount;
    localStorage.setItem("ankleHistory", JSON.stringify(history));

    document.getElementById("startBtn").textContent = "üì∑ Start Camera";
  }
};

document.getElementById("hudBtn").onclick = () => {
  hud.style.display = hud.style.display === "none" ? "block" : "none";
};

document.getElementById("csvBtn").onclick = () => {
  let csv = "date,count\n";
  for(const d in history){
    csv += `${d},${history[d]}\n`;
  }
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ankle_counts.csv";
  a.click();
};

// ---- detection loop ----
async function detectLoop(){
  if(!running) return;

  // ‚òÖ HUD ÁîüÂ≠ò„É≠„Ç∞ÔºàÊúÄÈáçË¶ÅÔºâ
  if(logs.length === 0){
    logs.push("detectLoop running...");
    hud.textContent = logs.join("\n");
  }

  const preds = await model.detect(video);
  const p = preds.find(x => x.class === "person");

  if(p){
    const footY = p.bbox[1]; // bbox TOP = Ë∂≥ÂÖàÂÅ¥
    const now = performance.now();

    if(lastFootY !== null){
      const dY = footY - lastFootY;

      if(Math.abs(dY) < JUMP_CUT){
        const sign = dY > 0 ? "+" : dY < 0 ? "-" : "0";
        let mark = "";

        if(!armed && Math.abs(dY) >= THRESH_ON && sign !== "0"){
          armed = true;
        }

        if(armed){
          const timeOK = (now - lastEventTime) >= LOCK_MS;
          const signOK = !lastSign || (sign !== lastSign && sign !== "0");

          if(timeOK && signOK && Math.abs(dY) >= THRESH_ON){
            sessionCount++;
            countNow.textContent = "Now: " + sessionCount;
            lastEventTime = now;
            lastSign = sign;
            armed = false;
            mark = " ‚òÖ";
          }

          if(Math.abs(dY) <= THRESH_OFF){
            armed = false;
          }
        }

        const log =
          `t:${((now-lastEventTime)/1000).toFixed(1)}s  ` +
          `footY:${footY.toFixed(0)}  dY:${dY.toFixed(0)}  sign:${sign}${mark}`;

        logs.push(log);
        if(logs.length > MAX_LOGS) logs.shift();
        hud.textContent = logs.join("\n");
      }
    }

    lastFootY = footY;
  }

  requestAnimationFrame(detectLoop);
}
</script>

</body>
</html>
