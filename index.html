<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ankle Dorsi/Plantar Flexion Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  background:#fff;
  color:#000;
  font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#header{
  text-align:center;
  padding:8px;
}
#title{
  font-size:18px;
  font-weight:600;
}
#count{
  font-size:32px;
  margin-top:4px;
}
video{
  width:100%;
  height:auto;
  background:#000;
}
#controls{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:6px;
  padding:8px;
}
button{
  font-size:14px;
}
#hudPanel{
  display:none;
  padding:8px;
}
#hudText{
  white-space:pre-wrap;
  font-size:11px;
  max-height:220px;
  overflow-y:auto;
  border:1px solid #000;
  padding:4px;
}
</style>
</head>

<body>

<div id="header">
  <div id="title">Ankle Dorsi/Plantar Flexion Counter</div>
  <div id="count">Now: 0</div>
</div>

<video id="video" autoplay playsinline></video>

<div id="controls">
  <button id="startBtn">ğŸ“· Start Camera</button>
  <button id="frontBtn">Front</button>
  <button id="backBtn">Back</button>
  <button id="hudBtn">HUD</button>
  <button id="csvBtn">CSV</button>
</div>

<div id="hudPanel">
  <pre id="hudText"></pre>
  <button id="hudCopyBtn">ğŸ“‹ Copy HUD Log</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
/* ======================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
====================== */
let video = document.getElementById("video");
let model = null;
let running = false;
let facing = "environment";

let lastY = null;
let lastTime = null;

let totalCountToday = 0;
let sessionCount = 0;

let motionTimes = []; // â˜…æ¡ä»¶ã«åˆæ ¼ã—ãŸæ™‚åˆ»ï¼ˆå¹³å‡é€Ÿåº¦ç”¨ï¼‰

let hudLines = [];
let showHUD = false;

/* ======================
   UIå‚ç…§
====================== */
const countEl = document.getElementById("count");
const hudPanel = document.getElementById("hudPanel");
const hudText  = document.getElementById("hudText");

/* ======================
   ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
====================== */
async function startCamera(){
  if(running){
    stopCamera();
    return;
  }
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:facing }
  });
  video.srcObject = stream;

  if(!model){
    model = await cocoSsd.load();
  }

  running = true;
  sessionCount = 0;
  lastY = null;
  lastTime = null;

  detectLoop();
}

function stopCamera(){
  running = false;
  if(video.srcObject){
    video.srcObject.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
  }
}

/* ======================
   ãƒ¡ã‚¤ãƒ³æ¤œå‡ºãƒ«ãƒ¼ãƒ—
====================== */
async function detectLoop(){
  if(!running) return;

  const now = performance.now();
  const preds = await model.detect(video);
  const person = preds.find(p=>p.class==="person");

  if(person){
    const bbox = person.bbox;
    const topY = bbox[1];
    const centerY = bbox[1] + bbox[3]/2;
    const height = bbox[3];

    if(lastY !== null && lastTime !== null){
      const dY = centerY - lastY;
      const dt = (now - lastTime)/1000;

      let sign = "0";
      if(dY > 3) sign = "+";
      else if(dY < -3) sign = "-";

      let starred = false;

      /* â˜… åˆ¤å®šæ¡ä»¶ï¼ˆBä»•æ§˜ï¼‰ */
      if(Math.abs(dY) >= 20 && dt >= 0.5 && dt <= 2.0){
        sessionCount++;
        totalCountToday++;
        motionTimes.push(now);

        starred = true;
        countEl.textContent = "Now: " + totalCountToday;
      }

      /* HUDãƒ­ã‚°ï¼ˆè¦³æ¸¬å€¤å®Œå…¨ä¿æŒï¼‰ */
      hudLines.push(
        `t:${dt.toFixed(1)}s  topY:${Math.round(topY)}  centerY:${Math.round(centerY)}  height:${Math.round(height)}  dY:${Math.round(dY)}  sign:${sign}${starred?" â˜…":""}`
      );

      if(hudLines.length > 300) hudLines.shift();
      if(showHUD) hudText.textContent = hudLines.join("\n");
    }

    lastY = centerY;
    lastTime = now;
  }

  requestAnimationFrame(detectLoop);
}

/* ======================
   å¹³å‡é€Ÿåº¦è¨ˆç®—ï¼ˆBä»•æ§˜ï¼‰
   ãƒ»â˜…ãŒ3å›ä»¥ä¸Š
   ãƒ»â˜…é–“éš” 0.5â€“2.0 ç§’ã®ã¿
====================== */
function calcAverageSpeed(){
  if(motionTimes.length < 3) return "";

  let validIntervals = [];
  for(let i=1;i<motionTimes.length;i++){
    const dt = (motionTimes[i]-motionTimes[i-1])/1000;
    if(dt >= 0.5 && dt <= 2.0){
      validIntervals.push(dt);
    }
  }
  if(validIntervals.length < 2) return "";

  const avg = validIntervals.reduce((a,b)=>a+b,0)/validIntervals.length;
  return avg.toFixed(2);
}

/* ======================
   CSVå‡ºåŠ›ï¼ˆBä»•æ§˜ï¼‰
====================== */
function exportCSV(){
  const today = new Date();
  const dateStr = today.toISOString().slice(0,10);
  const avgSpeed = calcAverageSpeed();

  const csv =
`date,total_count,avg_interval_sec
${dateStr},${totalCountToday},${avgSpeed}
`;

  const fname =
    "AnkleCounter_" +
    dateStr.replace(/-/g,"") +
    ".csv";

  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();
}

/* ======================
   UIã‚¤ãƒ™ãƒ³ãƒˆ
====================== */
document.getElementById("startBtn").onclick = startCamera;

document.getElementById("frontBtn").onclick = ()=>{
  facing = "user";
};

document.getElementById("backBtn").onclick = ()=>{
  facing = "environment";
};

document.getElementById("hudBtn").onclick = ()=>{
  showHUD = !showHUD;
  hudPanel.style.display = showHUD ? "block" : "none";
  hudText.textContent = hudLines.join("\n");
};

document.getElementById("hudCopyBtn").onclick = ()=>{
  navigator.clipboard.writeText(hudText.textContent);
};

document.getElementById("csvBtn").onclick = exportCSV;
</script>

</body>
</html>
